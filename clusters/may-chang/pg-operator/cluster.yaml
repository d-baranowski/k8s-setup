apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: db-cluster
  namespace: default
spec:
  instances: 2
  # Use a CloudNativePG image that includes barman-cloud-wal-archive
  imageName: ghcr.io/cloudnative-pg/postgresql:17.5-bullseye
  enableSuperuserAccess: true
  superuserSecret:
    name: db-cluster-superuser

  managed:
    roles:
      - name: utro
        ensure: present
        login: true
        superuser: true
        createdb: true
        createrole: true
        inherit: false
        replication: false
        bypassrls: true
        inRoles: &pg_privileged_roles
          - pg_checkpoint
          - pg_create_subscription
          - pg_database_owner
          - pg_execute_server_program
          - pg_maintain
          - pg_monitor
          - pg_read_all_data
          - pg_read_all_settings
          - pg_read_all_stats
          - pg_read_server_files
          - pg_signal_backend
          - pg_stat_scan_tables
          - pg_use_reserved_connections
          - pg_write_all_data
          - pg_write_server_files
        passwordSecret:
          name: utro-db-user
      - name: n8n
        ensure: present
        login: true
        superuser: true
        createdb: true
        createrole: true
        inherit: false
        replication: false
        bypassrls: true
        inRoles: *pg_privileged_roles
        passwordSecret:
          name: n8n-db-user

  bootstrap:
    initdb:
      database: postgres
      owner: owner
      secret:
        name: db-cluster-superuser
      postInitSQL:
        - |
            ALTER ROLE owner WITH LOGIN;
            GRANT ALL PRIVILEGES ON DATABASE postgres TO owner;

  postgresql:
    parameters:
      wal_level: logical
      max_replication_slots: "4"
      max_wal_senders: "10"

  storage:
    storageClass: openebs-hostpath
    size: 20Gi

  backup:
    retentionPolicy: 30d
    barmanObjectStore:
      destinationPath: s3://k8s-local-postgresql-backups
      s3Credentials:
        accessKeyId:
          name: aws-access-key
          key: value
        secretAccessKey:
          name: aws-secret-access-key
          key: value
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: db-cluster
  namespace: default
spec:
  schedule: "0 12 * * 7"
  immediate: true
  backupOwnerReference: self
  cluster:
    name: db-cluster